<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEALTHOPIA ‚Äî Order Form</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f6f6f6;
      --soft:#ffffff;
      --text:#111111;
      --muted:#666666;
      --line:#e5e5e5;

      --accent:#111111;
      --accent2:#333333;
      --danger:#111111;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:22px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter: blur(6px);z-index:10}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0;font-size:22px;letter-spacing:.5px}
    .sub{color:var(--muted);margin-top:6px;font-size:13px;line-height:1.45}
    main{padding:18px 16px 40px}
    .grid{display:grid;grid-template-columns: 1.25fr .95fr;gap:16px}
    @media (max-width: 940px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .panel-h{padding:14px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .panel-h h2{margin:0;font-size:14px;font-weight:800;letter-spacing:.4px}
    .pill{font-size:12px;color:var(--muted)}
    .panel-b{padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);background:transparent;color:var(--text);padding:8px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .tab[aria-selected="true"]{border-color:rgba(17,17,17,.6);box-shadow:0 0 0 2px rgba(17,17,17,.10) inset}
    .items{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width: 560px){.items{grid-template-columns:1fr}}
    .itembtn{
      width:100%;
      border:1px solid var(--line);
      background:var(--soft);
      color:var(--text);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      text-align:left;
      display:flex;
      justify-content:space-between;
      gap:10px;
      transition:transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .itembtn:hover{border-color:rgba(17,17,17,.35)}
    .itembtn:active{transform:scale(.99)}
    .iname{font-weight:900}
    .iprice{white-space:nowrap;text-align:right}
    .iprice .u{color:var(--accent2);font-weight:900;font-size:12px}
    .iprice .h{color:var(--muted);font-size:12px;margin-top:4px}
    .muted{color:var(--muted);font-size:12px}

    .selector{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(17,17,17,.03);
      border-radius:14px;
      padding:12px;
      display:none;
      gap:10px;
    }
    .sel-top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .sel-title{font-weight:900}
    .sel-sub{color:var(--muted);font-size:12px;margin-top:4px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    input[type="number"], input[type="text"], textarea, select{
      width:100%;background:var(--soft);border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:12px;outline:none
    }
    input[type="number"]{max-width:160px}
    textarea{min-height:84px;resize:vertical}
    select{appearance:none}

    .btn{
      border:1px solid var(--line);
      background:var(--soft);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900
    }
    .btn-primary{
      background:rgba(17,17,17,.06);
      border-color:rgba(17,17,17,.35)
    }
    .btn-primary:hover{background:rgba(17,17,17,.10)}
    .btn-danger{
      background:rgba(17,17,17,.04);
      border-color:rgba(17,17,17,.25)
    }
    .btn-danger:hover{background:rgba(17,17,17,.07)}
    .btn-ghost{background:transparent}

    .cart{display:flex;flex-direction:column;gap:10px}
    .cart-item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .cart-item .meta{display:flex;flex-direction:column;gap:4px}
    .cart-item .meta .small{color:var(--muted);font-size:12px}
    .cart-item .right{display:flex;gap:8px;align-items:center}

    .totalbox{border-top:1px solid var(--line);margin-top:12px;padding-top:12px;display:grid;gap:8px}
    .kv{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:13px}
    .kv strong{color:var(--text)}
    .warn{
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed rgba(17,17,17,.35);
      background:rgba(17,17,17,.04);
      color:var(--text);
      font-size:12px
    }
    .ok{
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed rgba(17,17,17,.35);
      background:rgba(17,17,17,.04);
      color:var(--text);
      font-size:12px
    }

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}

    .tlink{
      font-weight:900;
      text-decoration:underline;
      cursor:pointer;
    }

    .ticket-area{
      display:none;
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(17,17,17,.03);
      padding:14px;
      text-align:center;
    }
    .ticket-code{
      margin-top:8px;
      font-weight:900;
      font-size:16px;
    }
    .ticket-template{
      margin-top:10px;
      text-align:left;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:var(--soft);
      white-space:pre-wrap;
    }
    .ticket-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal-card{
      width:min(860px, 100%);
      background:var(--soft);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      position:relative;
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:10px;
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(17,17,17,.06);
      cursor:pointer;
      font-weight:900;
    }
    .modal-body{
      padding:12px;
      display:grid;
      gap:12px;
    }
    .modal-img{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .modal-accept{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:rgba(17,17,17,.03);
      cursor:pointer;
      user-select:none;
    }
    .check{
      width:22px;height:22px;border-radius:7px;
      border:1px solid var(--line);
      display:grid;place-items:center;
      background:var(--soft);
      font-weight:900;
    }
    .modal-accept strong{font-weight:900}
    .modal-accept .desc{color:var(--muted);font-size:12px;margin-top:2px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>WEALTHOPIA ‚Äî Order Form</h1>
    <div class="sub">
      Pilih item ‚Üí akan muncul input qty + tombol ‚ÄúTambah ke Keranjang‚Äù.<br>
      <strong>Minimal total order: 100 item</strong> (tidak wajib kelipatan 100).
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="panel">
      <div class="panel-h">
        <h2>Pilih Item</h2>
        <div class="pill">Klik item untuk mulai</div>
      </div>
      <div class="panel-b">
        <div class="tabs" id="tabs"></div>
        <div class="items" id="items"></div>

        <div class="selector" id="selector">
          <div class="sel-top">
            <div>
              <div class="sel-title" id="selTitle">Item</div>
              <div class="sel-sub" id="selSub">Harga</div>
            </div>
            <button class="btn btn-ghost" id="selClose" title="Tutup" type="button">‚úï</button>
          </div>

          <div class="row">
            <div style="min-width:160px">
              <div class="muted" style="margin-bottom:6px">Qty</div>
              <input id="selQty" type="number" min="0" step="5" value="0" />
            </div>

            <button class="btn" id="minusStep" type="button">-5</button>
            <button class="btn" id="plusStep" type="button">+5</button>

            <button class="btn btn-primary" id="selAdd" type="button">Tambah ke Keranjang</button>
          </div>

          <div class="muted" id="selHint">Masukkan qty (kelipatan 5), lalu klik ‚ÄúTambah ke Keranjang‚Äù.</div>
        </div>
      </div>
    </section>

    <aside class="panel">
      <div class="panel-h">
        <h2>Keranjang & Checkout</h2>
        <div class="pill" id="cartCount">0 jenis</div>
      </div>

      <div class="panel-b">
        <div class="cart" id="cart"></div>

        <button class="btn btn-danger" id="clearCart" type="button" style="margin-top:8px;display:none;">Kosongkan Keranjang</button>

        <div class="totalbox">
          <div class="kv"><span>Total Qty</span><strong id="totalQty">0</strong></div>
          <div class="kv" id="handlingRow" style="display:none;"><span>Handling Multi Area</span><strong id="handlingFee">Rp0</strong></div>
          <div class="kv"><span>Total Harga</span><strong id="totalPrice">Rp0</strong></div>

          <div id="ruleBox" class="warn" style="display:none;"></div>

          <div id="okBox" class="ok" style="display:none;">
            Kamu bisa membaca <span class="tlink" id="openTnc"><strong>Syarat dan Ketentuan</strong></span> di sini.
          </div>
        </div>

        <hr>

        <div style="display:grid;gap:10px">
          <div>
            <div class="muted" style="margin-bottom:6px">Nama / Inisial</div>
            <input id="custName" type="text" placeholder="Contoh: Dini / DJ" />
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Username Telegram</div>
            <input id="custUser" type="text" placeholder="Contoh: @username (wajib)" />
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Metode Login</div>
            <select id="loginMethod">
              <option value="" selected disabled>Pilih metode login (wajib)</option>
              <option value="Google">Google</option>
              <option value="Facebook">Facebook</option>
            </select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Catatan (opsional)</div>
            <textarea id="custNote" placeholder="Contoh: Tolong fokus blueberry dulu, lalu rasberry."></textarea>
          </div>

          <button class="btn btn-primary" id="sendTG" type="button">Order Sekarang</button>

          <div class="ticket-area" id="ticketArea">
            <div style="font-weight:900">Berhasil dikirim.</div>
            <div class="ticket-code mono" id="ticketCode"></div>

            <div class="muted" style="margin-top:10px;margin-bottom:6px">Template (auto-salin):</div>
            <div class="ticket-template mono" id="ticketTemplate"></div>

            <div class="ticket-actions">
              <button class="btn btn-primary" id="copyTicket" type="button">Salin Tiket</button>
              <a class="btn" id="openBot" href="https://t.me/wealthopiabot" target="_blank" rel="noopener">Buka Bot</a>
            </div>
          </div>
        </div>
      </div>
    </aside>

  </div>
</main>

<div class="modal" id="tncModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="Syarat dan Ketentuan">
    <button class="modal-close" id="tncClose" type="button" title="Tutup">‚úï</button>
    <div class="modal-body">
      <img class="modal-img" alt="Syarat dan Ketentuan" src="https://keeptnc.carrd.co/assets/images/gallery01/d292c96a_original.jpg?v=290756c8" />
      <div class="modal-accept" id="tncAccept" role="button" tabindex="0">
        <div class="check" id="tncCheck"> </div>
        <div>
          <strong>Saya sudah membaca dan memahami syarat dan ketentuan</strong>
          <div class="desc">Klik untuk menutup pop-up.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const BOT_TOKEN = "8289857502:AAFelp66rhaB4MXBxKQAPnqafhbiK-EwDjE";
  const CHAT_ID = "-1003862510166";

  const BRAND = "WEALTHOPIA";
  const MIN_TOTAL_QTY = 100;
  const MIN_TOTAL_PRICE_WHEN_FARMING = 3500;

  const CATALOG = {
    Fruits: [
      { id:"blueberry", label:"ü´ê Blueberry", unit:30, kind:"unit", group:"farming" },
      { id:"apple",     label:"üçé Apple",     unit:30, kind:"unit", group:"farming" },
      { id:"rasberry",  label:"üçì Rasberry",  unit:40, kind:"unit", group:"farming" },
      { id:"mandarin",  label:"üçä Mandarin",  unit:40, kind:"unit", group:"farming" },
    ],
    Mushrooms: [
      { id:"oyster",    label:"üçÑ Oyster",    unit:25, kind:"unit", group:"farming" },
      { id:"shiitake",  label:"üçÑ Shiitake",  unit:25, kind:"unit", group:"farming" },
      { id:"button",    label:"üçÑ Button",    unit:25, kind:"unit", group:"farming" },
      { id:"pennybun",  label:"üçÑ Pennybun",  unit:25, kind:"unit", group:"farming" },
    ],
    Materials: [
      { id:"stone", label:"ü™® Stone", unit:23, kind:"unit", group:"farming" },
      { id:"ore",   label:"‚õèÔ∏è Ore",   unit:28, kind:"unit", group:"farming" },
    ],
    "Timber Package": [
      { id:"timberA", label:"ü™µ Timber Pack A", kind:"pack", rate:37, pack:{ timber:200, qtimber:30 }, packPrice:7500,  group:"timber" },
      { id:"timberB", label:"ü™µ Timber Pack B", kind:"pack", rate:37, pack:{ timber:300, qtimber:60 }, packPrice:11000, group:"timber" },
      { id:"timberC", label:"ü™µ Timber Pack C", kind:"pack", rate:37, pack:{ timber:400, qtimber:90 }, packPrice:15000, group:"timber" },
      { id:"timberD", label:"ü™µ Timber Pack D", kind:"pack", rate:37, pack:{ timber:500, qtimber:120 }, packPrice:18500, group:"timber" },
      { id:"timberE", label:"ü™µ Timber Pack E", kind:"pack", rate:37, pack:{ timber:600, qtimber:150 }, packPrice:22000, group:"timber" },
    ],
    "JOKI-QUEST / STORY": [
      { id:"dq", label:"üóìÔ∏è Daily Quest", kind:"quest_daily", qUnit:3000, qPackSize:5, qPackPrice:14000, group:"quest" },
      { id:"wq", label:"üìÖ Weekly Quest", kind:"quest", unit:4000, unitLabel:"/week", group:"quest" },
      { id:"mq", label:"üìñ Main Quest",   kind:"quest", unit:6000, unitLabel:"/quest", group:"quest" },
      { id:"gq", label:"üó£Ô∏è Gossip Quest", kind:"quest", unit:4000, unitLabel:"/quest", group:"quest" },
      { id:"fwp", label:"‚≠ê Full Week Package",     kind:"quest", unit:85000, unitLabel:"/week", group:"quest" },
      { id:"cwp", label:"‚úÖ Complete Week Package", kind:"quest", unit:89000, unitLabel:"/week", group:"quest" },
    ],
  };

  const cart = {};
  let activeTab = Object.keys(CATALOG)[0];
  let selectedItem = null;

  let tncAccepted = false;
  let lastTicket = "";

  const rupiah = (n) => "Rp" + Math.round(n).toLocaleString("id-ID");

  function parseQty(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return 0;
    return Math.floor(n);
  }

  function normalizeTGUsername(v){
    const raw = String(v || "").trim();
    if (!raw) return "";
    return raw.startsWith("@") ? raw.slice(1) : raw;
  }

  function yyyymmdd(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    return `${y}${m}${d}`;
  }

  function generateTicket(usernameTG){
    const u = normalizeTGUsername(usernameTG);
    const random3 = Math.floor(100 + Math.random() * 900);
    return `#${u}${random3}WTP${yyyymmdd()}`;
  }

  function ticketTemplate(ticket){
    return `Halo, aku mau order yaa. Ini tiketnya : ${ticket}. Untuk pembayarannya aku mau via QRIS.`;
  }

  function isFarming(it){ return it.group === "farming"; }
  function isTimber(it){ return it.group === "timber"; }
  function isQuest(it){ return it.group === "quest"; }

  function questDailySubtotal(it){
    const q = it.qty;
    const full = Math.floor(q / it.qPackSize);
    const rem  = q % it.qPackSize;
    return (full * it.qPackPrice) + (rem * it.qUnit);
  }

  function itemSubtotal(it){
    if (it.kind === "pack") return it.qty * it.packPrice;
    if (it.kind === "quest_daily") return questDailySubtotal(it);
    if (it.kind === "quest") return it.qty * it.unit;
    return it.qty * it.unit;
  }

  function itemQtyCount(it){
    if (it.kind === "pack"){
      return it.qty * ((it.pack?.timber || 0) + (it.pack?.qtimber || 0));
    }
    if (isQuest(it)) return 0;
    return it.qty;
  }

  function getHandlingFee(){
    const farmingEntries = Object.values(cart).filter(isFarming);
    const n = farmingEntries.length;
    if (n <= 1) return 0;
    if (n === 2) return 1500;
    return (n - 1) * 1000;
  }

  const tabsEl = document.getElementById("tabs");
  const itemsEl = document.getElementById("items");

  const selectorEl = document.getElementById("selector");
  const selTitleEl = document.getElementById("selTitle");
  const selSubEl   = document.getElementById("selSub");
  const selQtyEl   = document.getElementById("selQty");
  const selHintEl  = document.getElementById("selHint");
  const selAddBtn  = document.getElementById("selAdd");
  const selCloseBtn= document.getElementById("selClose");
  const minusStepBtn = document.getElementById("minusStep");
  const plusStepBtn = document.getElementById("plusStep");

  const cartEl  = document.getElementById("cart");
  const cartCountEl = document.getElementById("cartCount");
  const totalQtyEl = document.getElementById("totalQty");
  const handlingRowEl = document.getElementById("handlingRow");
  const handlingFeeEl = document.getElementById("handlingFee");
  const totalPriceEl = document.getElementById("totalPrice");
  const ruleBox = document.getElementById("ruleBox");
  const okBox = document.getElementById("okBox");
  const clearBtn = document.getElementById("clearCart");

  const sendBtn = document.getElementById("sendTG");

  const ticketArea = document.getElementById("ticketArea");
  const ticketCodeEl = document.getElementById("ticketCode");
  const ticketTemplateEl = document.getElementById("ticketTemplate");
  const copyBtn = document.getElementById("copyTicket");

  const tncModal = document.getElementById("tncModal");
  const tncClose = document.getElementById("tncClose");
  const tncAccept = document.getElementById("tncAccept");
  const tncCheck = document.getElementById("tncCheck");
  const openTnc = document.getElementById("openTnc");

  function renderTabs(){
    tabsEl.innerHTML = "";
    Object.keys(CATALOG).forEach((cat)=>{
      const b = document.createElement("button");
      b.className = "tab";
      b.textContent = cat;
      b.type = "button";
      b.setAttribute("aria-selected", String(cat===activeTab));
      b.addEventListener("click", ()=>{
        activeTab = cat;
        renderTabs();
        renderItems();
        hideSelector();
      });
      tabsEl.appendChild(b);
    });
  }

  function renderItems(){
    const list = CATALOG[activeTab];
    itemsEl.innerHTML = "";

    list.forEach((it)=>{
      const btn = document.createElement("button");
      btn.className = "itembtn";
      btn.type = "button";

      if (it.kind === "pack"){
        const timber = it.pack?.timber || 0;
        const qtimber = it.pack?.qtimber || 0;
        btn.innerHTML = `
          <div>
            <div class="iname">${it.label}</div>
            <div class="muted">${timber} Timber ü™µ + ${qtimber} Quality Timber üå≥</div>
          </div>
          <div class="iprice">
            <div class="u">${rupiah(it.packPrice)}/pack</div>
            <div class="h">Rate: ${rupiah(it.rate)}/Timber</div>
          </div>
        `;
      } else if (it.kind === "quest_daily"){
        btn.innerHTML = `
          <div>
            <div class="iname">${it.label}</div>
            <div class="muted">${rupiah(it.qPackPrice)}/5 quest</div>
          </div>
          <div class="iprice">
            <div class="u">${rupiah(it.qUnit)}/quest</div>
            <div class="h">Klik untuk pilih</div>
          </div>
        `;
      } else if (it.kind === "quest"){
        const ul = it.unitLabel || "";
        btn.innerHTML = `
          <div>
            <div class="iname">${it.label}</div>
            <div class="muted">${rupiah(it.unit)}${ul}</div>
          </div>
          <div class="iprice">
            <div class="u">${rupiah(it.unit)}${ul}</div>
            <div class="h">Klik untuk pilih</div>
          </div>
        `;
      } else {
        btn.innerHTML = `
          <div>
            <div class="iname">${it.label}</div>
            <div class="muted">${rupiah(it.unit * 100)}/100</div>
          </div>
          <div class="iprice">
            <div class="u">${rupiah(it.unit)}/item</div>
            <div class="h">Klik untuk pilih</div>
          </div>
        `;
      }

      btn.addEventListener("click", ()=>{ showSelector(it); });
      itemsEl.appendChild(btn);
    });
  }

  function showSelector(item){
    selectedItem = item;

    if (item.kind === "pack"){
      const timber = item.pack?.timber || 0;
      const qtimber = item.pack?.qtimber || 0;
      selTitleEl.textContent = item.label;
      selSubEl.textContent = `${timber} Timber ü™µ + ${qtimber} Quality Timber üå≥ ‚Ä¢ ${rupiah(item.packPrice)}/pack ‚Ä¢ Rate ${rupiah(item.rate)}/Timber`;
      selQtyEl.min = 0;
      selQtyEl.step = 1;
      selQtyEl.value = 0;
      minusStepBtn.textContent = "-1";
      plusStepBtn.textContent = "+1";
      selHintEl.textContent = "Masukkan jumlah pack (1,2,3...), lalu klik ‚ÄúTambah ke Keranjang‚Äù.";
    } else if (item.kind === "quest_daily"){
      selTitleEl.textContent = item.label;
      selSubEl.textContent = `${rupiah(item.qUnit)}/quest ‚Ä¢ ${rupiah(item.qPackPrice)}/5 quest`;
      selQtyEl.min = 0;
      selQtyEl.step = 1;
      selQtyEl.value = 0;
      minusStepBtn.textContent = "-1";
      plusStepBtn.textContent = "+1";
      selHintEl.textContent = "Masukkan jumlah quest, lalu klik ‚ÄúTambah ke Keranjang‚Äù.";
    } else if (item.kind === "quest"){
      const ul = item.unitLabel || "";
      selTitleEl.textContent = item.label;
      selSubEl.textContent = `${rupiah(item.unit)}${ul}`;
      selQtyEl.min = 0;
      selQtyEl.step = 1;
      selQtyEl.value = 0;
      minusStepBtn.textContent = "-1";
      plusStepBtn.textContent = "+1";
      selHintEl.textContent = "Masukkan jumlah, lalu klik ‚ÄúTambah ke Keranjang‚Äù.";
    } else {
      selTitleEl.textContent = item.label;
      selSubEl.textContent = `${rupiah(item.unit)}/item ‚Ä¢ ${rupiah(item.unit*100)}/100`;
      selQtyEl.min = 0;
      selQtyEl.step = 5;
      selQtyEl.value = 0;
      minusStepBtn.textContent = "-5";
      plusStepBtn.textContent = "+5";
      selHintEl.textContent = "Masukkan qty (kelipatan 5), lalu klik ‚ÄúTambah ke Keranjang‚Äù.";
    }

    selectorEl.style.display = "grid";
    selectorEl.scrollIntoView({ behavior:"smooth", block:"nearest" });
  }

  function hideSelector(){
    selectedItem = null;
    selectorEl.style.display = "none";
  }

  function addToCart(item, qty){
    if (!cart[item.id]){
      cart[item.id] = { ...item, qty };
    } else {
      cart[item.id].qty += qty;
    }
    recalc();
  }

  function clearCart(){
    Object.keys(cart).forEach(k => delete cart[k]);
    recalc();
  }

  function getTotals(){
    const entries = Object.values(cart);
    const baseQty = entries.reduce((a,b)=>a + itemQtyCount(b), 0);
    const basePrice = entries.reduce((a,b)=>a + itemSubtotal(b), 0);
    const handlingFee = getHandlingFee();
    const totalPrice = basePrice + handlingFee;
    return { baseQty, basePrice, handlingFee, totalPrice };
  }

  function getFarmingTotals(){
    const farmingEntries = Object.values(cart).filter(isFarming);
    const farmingQty = farmingEntries.reduce((a,b)=>a + (b.qty || 0), 0);
    const hasFarming = farmingEntries.length > 0;
    const hasFruitsOrMush = farmingEntries.some(it => (it.id !== "stone" && it.id !== "ore") && it.group==="farming");
    const hasOnlyMaterials = hasFarming && farmingEntries.every(it => it.id === "stone" || it.id === "ore");
    return { farmingEntries, farmingQty, hasFarming, hasFruitsOrMush, hasOnlyMaterials };
  }

  function validateRules(){
    const entries = Object.values(cart);
    if (entries.length === 0) return { ok:false, msg:"Keranjang kosong." };

    for (const it of entries){
      if (!Number.isFinite(it.qty) || it.qty < 1){
        return { ok:false, msg:`Qty ${it.label} minimal 1.` };
      }
    }

    const { farmingEntries, farmingQty, hasFarming, hasOnlyMaterials } = getFarmingTotals();
    const { totalPrice } = getTotals();

    if (hasFarming){
      if (farmingQty < MIN_TOTAL_QTY){
        return { ok:false, msg:`Minimal total order ${MIN_TOTAL_QTY} item.` };
      }

      if (hasOnlyMaterials){
        for (const it of farmingEntries){
          if ((it.id === "stone" || it.id === "ore") && it.qty < 150){
            return { ok:false, msg:`Minimal order ${it.label} adalah 150.` };
          }
        }
      }

      if (totalPrice < MIN_TOTAL_PRICE_WHEN_FARMING){
        return { ok:false, msg:`Minimal transaksi Rp${MIN_TOTAL_PRICE_WHEN_FARMING.toLocaleString("id-ID")}.` };
      }
    }

    return { ok:true, msg:"OK" };
  }

  function validateFields(){
    const name = document.getElementById("custName").value.trim();
    const userRaw = document.getElementById("custUser").value.trim();
    const loginMethod = document.getElementById("loginMethod").value;
    const note = document.getElementById("custNote").value.trim();

    if (!name) return { ok:false, msg:"Nama / Inisial wajib diisi." };
    if (!userRaw) return { ok:false, msg:"Username Telegram wajib diisi." };
    const user = normalizeTGUsername(userRaw);
    if (!user) return { ok:false, msg:"Username Telegram wajib diisi." };
    if (!loginMethod) return { ok:false, msg:"Metode Login wajib dipilih." };

    return { ok:true, name, user, loginMethod, note };
  }

  function renderCart(){
    const entries = Object.values(cart);
    cartEl.innerHTML = "";

    if (entries.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "Keranjang masih kosong. Pilih item dari sebelah kiri.";
      cartEl.appendChild(empty);
      clearBtn.style.display = "none";
    } else {
      clearBtn.style.display = "block";
      entries.forEach((it)=>{
        const box = document.createElement("div");
        box.className = "cart-item";

        const meta = document.createElement("div");
        meta.className = "meta";

        const linePrice = itemSubtotal(it);

        if (it.kind === "pack"){
          const timber = it.pack?.timber || 0;
          const qtimber = it.pack?.qtimber || 0;
          const tTotal = it.qty * timber;
          const qTotal = it.qty * qtimber;

          meta.innerHTML = `
            <div style="font-weight:900">${it.label}</div>
            <div class="small">
              Pack: <strong style="color:var(--text)">${it.qty}</strong> ‚Ä¢ Isi: ${tTotal} Timber ü™µ + ${qTotal} Quality Timber üå≥
              ‚Ä¢ Subtotal: <strong style="color:var(--text)">${rupiah(linePrice)}</strong>
            </div>
          `;
        } else if (it.kind === "quest_daily"){
          const full = Math.floor(it.qty / it.qPackSize);
          const rem  = it.qty % it.qPackSize;
          const extra = (full > 0 || rem > 0)
            ? ` ‚Ä¢ (${full}√ó5 quest + ${rem} quest)`
            : "";
          meta.innerHTML = `
            <div style="font-weight:900">${it.label}</div>
            <div class="small">
              Qty: <strong style="color:var(--text)">${it.qty}</strong> quest${extra}
              ‚Ä¢ Subtotal: <strong style="color:var(--text)">${rupiah(linePrice)}</strong>
            </div>
          `;
        } else if (it.kind === "quest"){
          meta.innerHTML = `
            <div style="font-weight:900">${it.label}</div>
            <div class="small">
              Qty: <strong style="color:var(--text)">${it.qty}</strong>
              ‚Ä¢ Subtotal: <strong style="color:var(--text)">${rupiah(linePrice)}</strong>
            </div>
          `;
        } else {
          meta.innerHTML = `
            <div style="font-weight:900">${it.label}</div>
            <div class="small">
              Qty: <strong style="color:var(--text)">${it.qty}</strong> ‚Ä¢ Unit: ${rupiah(it.unit)}
              ‚Ä¢ Subtotal: <strong style="color:var(--text)">${rupiah(linePrice)}</strong>
            </div>
          `;
        }

        const right = document.createElement("div");
        right.className = "right";

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = 0;
        qtyInput.step = (it.kind === "pack" || it.kind === "quest" || it.kind === "quest_daily") ? 1 : 5;
        qtyInput.value = it.qty;

        qtyInput.addEventListener("change", ()=>{
          let q = parseQty(qtyInput.value);
          if (q < 0) q = 0;

          if (it.kind !== "pack" && it.kind !== "quest" && it.kind !== "quest_daily"){
            q = Math.round(q / 5) * 5;
            if (q < 0) q = 0;
          }

          if (q === 0){
            delete cart[it.id];
            recalc();
            return;
          }

          cart[it.id].qty = q;
          qtyInput.value = q;
          recalc();
        });

        const remove = document.createElement("button");
        remove.className = "btn btn-danger";
        remove.type = "button";
        remove.textContent = "Hapus";
        remove.addEventListener("click", ()=>{
          delete cart[it.id];
          recalc();
        });

        right.appendChild(qtyInput);
        right.appendChild(remove);

        box.appendChild(meta);
        box.appendChild(right);
        cartEl.appendChild(box);
      });
    }

    recalcTotalsUI();
  }

  function recalcTotalsUI(){
    const { baseQty, handlingFee, totalPrice } = getTotals();
    totalQtyEl.textContent = baseQty.toLocaleString("id-ID");

    if (handlingFee > 0){
      handlingRowEl.style.display = "flex";
      handlingFeeEl.textContent = rupiah(handlingFee);
    } else {
      handlingRowEl.style.display = "none";
    }

    totalPriceEl.textContent = rupiah(totalPrice);

    const countItems = Object.values(cart).length;
    cartCountEl.textContent = `${countItems} jenis`;

    const v = validateRules();
    if (!v.ok){
      ruleBox.style.display = "block";
      okBox.style.display = "none";
      ruleBox.textContent = v.msg;
    } else {
      ruleBox.style.display = "none";
      okBox.style.display = "block";
      okBox.innerHTML = `Kamu bisa membaca <span class="tlink" id="openTncInline"><strong>Syarat dan Ketentuan</strong></span> di sini.`;
      const inline = document.getElementById("openTncInline");
      if (inline) inline.addEventListener("click", openTncModal);
    }
  }

  function recalc(){
    renderCart();
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    } catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  function openTncModal(){
    tncModal.style.display = "flex";
    tncModal.setAttribute("aria-hidden", "false");
  }

  function closeTncModal(){
    tncModal.style.display = "none";
    tncModal.setAttribute("aria-hidden", "true");
  }

  async function sendTelegram(){
    ticketArea.style.display = "none";
    lastTicket = "";

    const r = validateRules();
    if (!r.ok){
      alert(r.msg);
      return;
    }

    const f = validateFields();
    if (!f.ok){
      alert(f.msg);
      return;
    }

    const ticket = generateTicket(f.user);
    const { baseQty, basePrice, handlingFee, totalPrice } = getTotals();

    const lines = Object.values(cart).map(it => {
      if (it.kind === "pack"){
        const timber = it.pack?.timber || 0;
        const qtimber = it.pack?.qtimber || 0;
        const tTotal = it.qty * timber;
        const qTotal = it.qty * qtimber;
        return `- ${it.label} | Pack ${it.qty} | Isi ${tTotal}ü™µ + ${qTotal}üå≥ | ${rupiah(itemSubtotal(it))}`;
      }
      if (it.kind === "quest_daily"){
        return `- ${it.label} | Qty ${it.qty} quest | ${rupiah(itemSubtotal(it))}`;
      }
      if (it.kind === "quest"){
        return `- ${it.label} | Qty ${it.qty} | ${rupiah(itemSubtotal(it))}`;
      }
      return `- ${it.label} | Qty ${it.qty} | ${rupiah(itemSubtotal(it))}`;
    });

    const noteBlock = f.note ? `\n\nCatatan:\n${f.note}` : "";

    const msg =
`üì¶ ${BRAND} ‚Äî ORDER

üéü Ticket: ${ticket}
Nama / Inisial: ${f.name}
Username Telegram: @${f.user}
Metode Login: ${f.loginMethod}

Detail Order:
${lines.join("\n")}

Total Qty: ${baseQty.toLocaleString("id-ID")}
Subtotal: ${rupiah(basePrice)}
${handlingFee > 0 ? `Handling Multi Area: ${rupiah(handlingFee)}\n` : ""}Total Harga: ${rupiah(totalPrice)}${noteBlock}`;

    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

    sendBtn.disabled = true;
    sendBtn.textContent = "Mengirim...";

    try{
      const res = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          chat_id: CHAT_ID,
          text: msg
        })
      });

      const data = await res.json();

      if (!data || !data.ok){
        alert("Gagal kirim ke Telegram.");
        return;
      }

      lastTicket = ticket;

      const template = ticketTemplate(ticket);
      ticketCodeEl.textContent = ticket;
      ticketTemplateEl.textContent = template;
      ticketArea.style.display = "block";

      await copyText(template);

      clearCart();
      hideSelector();

      ticketArea.scrollIntoView({ behavior:"smooth", block:"center" });

    } catch(e){
      alert("Terjadi kesalahan saat mengirim.");
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = "Order Sekarang";
    }
  }

  selCloseBtn.addEventListener("click", hideSelector);

  minusStepBtn.addEventListener("click", ()=>{
    if (!selectedItem) return;
    let q = parseQty(selQtyEl.value);

    if (selectedItem.kind === "pack" || selectedItem.kind === "quest" || selectedItem.kind === "quest_daily"){
      q = Math.max(0, q - 1);
    } else {
      q = Math.max(0, Math.round(q / 5) * 5 - 5);
    }

    selQtyEl.value = q;
  });

  plusStepBtn.addEventListener("click", ()=>{
    if (!selectedItem) return;
    let q = parseQty(selQtyEl.value);

    if (selectedItem.kind === "pack" || selectedItem.kind === "quest" || selectedItem.kind === "quest_daily"){
      q = Math.max(0, q + 1);
    } else {
      q = Math.max(0, Math.round(q / 5) * 5 + 5);
    }

    selQtyEl.value = q;
  });

  selQtyEl.addEventListener("change", ()=>{
    if (!selectedItem) return;
    let q = parseQty(selQtyEl.value);
    if (q < 0) q = 0;

    if (selectedItem.kind !== "pack" && selectedItem.kind !== "quest" && selectedItem.kind !== "quest_daily"){
      q = Math.round(q / 5) * 5;
      if (q < 0) q = 0;
    }

    selQtyEl.value = q;
  });

  selAddBtn.addEventListener("click", ()=>{
    if (!selectedItem) return;

    let q = parseQty(selQtyEl.value);

    if (selectedItem.kind === "pack" || selectedItem.kind === "quest" || selectedItem.kind === "quest_daily"){
      if (q < 1){
        alert("Jumlah minimal 1.");
        return;
      }
      addToCart(selectedItem, q);
      selQtyEl.value = 0;
      selHintEl.textContent = "Ditambahkan ke keranjang. Kamu bisa pilih item lain lagi.";
      return;
    }

    q = Math.round(q / 5) * 5;
    if (q < 1){
      alert("Qty minimal 1 (kelipatan 5).");
      return;
    }

    addToCart(selectedItem, q);
    selQtyEl.value = 0;
    selHintEl.textContent = "Ditambahkan ke keranjang. Kamu bisa pilih item lain lagi.";
  });

  openTnc.addEventListener("click", openTncModal);
  tncClose.addEventListener("click", closeTncModal);

  tncAccept.addEventListener("click", ()=>{
    tncAccepted = true;
    tncCheck.textContent = "‚úì";
    closeTncModal();
  });
  tncAccept.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" || e.key === " "){
      e.preventDefault();
      tncAccepted = true;
      tncCheck.textContent = "‚úì";
      closeTncModal();
    }
  });

  clearBtn.addEventListener("click", clearCart);
  sendBtn.addEventListener("click", sendTelegram);

  copyBtn.addEventListener("click", async ()=>{
    if (!lastTicket) return;
    const template = ticketTemplate(lastTicket);
    const ok = await copyText(template);
    if (ok) copyBtn.textContent = "Tersalin ‚úì";
    setTimeout(()=>{ copyBtn.textContent = "Salin Tiket"; }, 1200);
  });

  renderTabs();
  renderItems();
  renderCart();
</script>
</body>
</html>
